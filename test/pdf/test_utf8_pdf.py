#!/usr/bin/env python3
"""UTF-8 í•œê¸€ PDF ìƒì„± í…ŒìŠ¤íŠ¸"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.dirname(os.path.abspath(__file__)))))

import asyncio
from datetime import datetime
from utils.pdf_generator import ChatbotReportGenerator

async def test_utf8_korean_pdf():
    """í•œê¸€ UTF-8 PDF ìƒì„± í…ŒìŠ¤íŠ¸"""
    print("ğŸ‡°ğŸ‡· í•œê¸€ UTF-8 PDF ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œì‘...")
    
    # PDF ìƒì„±ê¸° ì´ˆê¸°í™”
    pdf_generator = ChatbotReportGenerator()
    
    # í•œê¸€ í…ŒìŠ¤íŠ¸ ë°ì´í„°
    session_info = {
        'session_id': 'sess_í•œê¸€í…ŒìŠ¤íŠ¸_12345',
        'user_id': 'ê¹€ì² ìˆ˜_ì‚¬ìš©ì',
        'issue_code': 'í”„ë ˆìŠ¤_ì†ŒìŒ_ë¬¸ì œ',
        'created_at': '2025-08-08 13:45:00',
        'ended_at': '2025-08-08 13:50:00',
        'conversation_count': 3,
        'participating_agents': ['GPTì—ì´ì „íŠ¸', 'ì§€ë¯¸ë‹ˆì—ì´ì „íŠ¸', 'í´ë¡œë°”ì—ì´ì „íŠ¸']
    }
    
    # í•œê¸€ ëŒ€í™” ë‚´ì—­
    conversation_history = [
        {
            'user_message': 'ì•ˆë…•í•˜ì„¸ìš”! í”„ë ˆìŠ¤ ê¸°ê³„ì—ì„œ ì´ìƒí•œ ì†ŒìŒì´ ë‚©ë‹ˆë‹¤. ë„ì›€ì„ ë°›ì„ ìˆ˜ ìˆì„ê¹Œìš”? ğŸ”§',
            'bot_response': 'ì•ˆë…•í•˜ì„¸ìš”! í”„ë ˆìŠ¤ ê¸°ê³„ì˜ ì†ŒìŒ ë¬¸ì œë¡œ ë¬¸ì˜ì£¼ì…¨êµ°ìš”. ì–´ë–¤ ì¢…ë¥˜ì˜ ì†ŒìŒì¸ì§€ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì‹¤ ìˆ˜ ìˆë‚˜ìš”? (ì˜ˆ: ì‚ê±±ê±°ë¦¬ëŠ” ì†Œë¦¬, ì¿µì¿µê±°ë¦¬ëŠ” ì†Œë¦¬, ìœ™ìœ™ê±°ë¦¬ëŠ” ì†Œë¦¬ ë“±)',
            'timestamp': '2025-08-08 13:45:30'
        },
        {
            'user_message': 'ê¸°ê³„ë¥¼ ì‘ë™ì‹œí‚¬ ë•Œë§ˆë‹¤ "ì¿µì¿µ" í•˜ëŠ” ì†Œë¦¬ê°€ ë‚˜ê³ , ê°€ë”ì”© "ì‚ê±±ì‚ê±±" ì†Œë¦¬ë„ ë“¤ë¦½ë‹ˆë‹¤. íŠ¹íˆ ì••ë ¥ì´ ìµœëŒ€ì¼ ë•Œ ë” ì‹¬í•´ì§‘ë‹ˆë‹¤.',
            'bot_response': 'ë§ì”€í•´ì£¼ì‹  ì¦ìƒìœ¼ë¡œ ë³´ì•„ ë‹¤ìŒê³¼ ê°™ì€ ì›ì¸ë“¤ì„ ì˜ì‹¬í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n\n1. ìœ ì•• ì‹œìŠ¤í…œì˜ ì••ë ¥ ë¶ˆê· í˜•\n2. ë² ì–´ë§ ë§ˆëª¨ë¡œ ì¸í•œ ì§„ë™\n3. ì˜¤ì¼ ë¶€ì¡± ë˜ëŠ” ì˜¤ì—¼\n\në¨¼ì € ìœ ì•• ì˜¤ì¼ ë ˆë²¨ì„ í™•ì¸í•´ë³´ì‹œê³ , ë² ì–´ë§ ë¶€ë¶„ì— ì´ìƒì´ ì—†ëŠ”ì§€ ì ê²€í•´ì£¼ì„¸ìš”.',
            'timestamp': '2025-08-08 13:47:15'
        },
        {
            'user_message': 'ë„¤, ê°ì‚¬í•©ë‹ˆë‹¤! ìœ ì•• ì˜¤ì¼ì„ í™•ì¸í•´ë³´ë‹ˆ ìƒ‰ê¹”ì´ íƒí•´ì ¸ ìˆì—ˆìŠµë‹ˆë‹¤. êµì²´í•˜ë©´ ë¬¸ì œê°€ í•´ê²°ë ê¹Œìš”?',
            'bot_response': 'ë„¤, ì •í™•í•œ ì§„ë‹¨ì´ì‹­ë‹ˆë‹¤! ìœ ì•• ì˜¤ì¼ì´ íƒí•´ì¡Œë‹¤ëŠ” ê²ƒì€ ì˜¤ì—¼ë˜ì—ˆê±°ë‚˜ ìˆ˜ëª…ì´ ë‹¤í–ˆë‹¤ëŠ” ì‹ í˜¸ì…ë‹ˆë‹¤. ë‹¤ìŒ ìˆœì„œë¡œ ì¡°ì¹˜í•´ì£¼ì„¸ìš”:\n\nâœ… 1ë‹¨ê³„: ê¸°ì¡´ ì˜¤ì¼ ì™„ì „ ë°°ì¶œ\nâœ… 2ë‹¨ê³„: í•„í„° êµì²´\nâœ… 3ë‹¨ê³„: ìƒˆ ìœ ì•• ì˜¤ì¼ ì£¼ì…\nâœ… 4ë‹¨ê³„: ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸\n\nì‘ì—… í›„ ì†ŒìŒì´ ì¤„ì–´ë“¤ ê²ƒìœ¼ë¡œ ì˜ˆìƒë©ë‹ˆë‹¤. ì¶”ê°€ ë¬¸ì œê°€ ìˆìœ¼ì‹œë©´ ì–¸ì œë“  ë¬¸ì˜ì£¼ì„¸ìš”! ğŸ˜Š',
            'timestamp': '2025-08-08 13:49:30'
        }
    ]
    
    # ìµœì¢… ìš”ì•½ (í•œê¸€)
    final_summary = """í”„ë ˆìŠ¤ ê¸°ê³„ ì†ŒìŒ ë¬¸ì œ í•´ê²° ìƒë‹´ ìš”ì•½:
    
ğŸ” ë¬¸ì œì :
- í”„ë ˆìŠ¤ ì‘ë™ ì‹œ ì¿µì¿µê±°ë¦¬ëŠ” ì†ŒìŒ
- ì••ë ¥ ìµœëŒ€ ì‹œ ì‚ê±±ê±°ë¦¬ëŠ” ì†ŒìŒ ë°œìƒ
- ìœ ì•• ì˜¤ì¼ íƒí•¨ í™•ì¸

ğŸ’¡ í•´ê²°ë°©ì•ˆ:
- ìœ ì•• ì˜¤ì¼ êµì²´ (ì˜¤ì—¼ëœ ì˜¤ì¼ í™•ì¸ë¨)
- í•„í„° êµì²´ ë™ì‹œ ì§„í–‰
- ì‹œìŠ¤í…œ ì „ì²´ ì ê²€ ìˆ˜í–‰

ğŸ“‹ ì‘ì—… ìˆœì„œ:
1. ê¸°ì¡´ ì˜¤ì¼ ë°°ì¶œ
2. í•„í„° êµì²´
3. ìƒˆ ì˜¤ì¼ ì£¼ì…
4. ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸

ì˜ˆìƒ ê²°ê³¼: ì†ŒìŒ ë¬¸ì œ í•´ê²° ë° ê¸°ê³„ ì„±ëŠ¥ í–¥ìƒ ê¸°ëŒ€ë©ë‹ˆë‹¤."""
    
    try:
        # PDF ìƒì„±
        pdf_buffer = await pdf_generator.generate_chat_report(
            session_id=session_info['session_id'],
            conversation_history=conversation_history,
            session_info=session_info,
            final_summary=final_summary
        )
        
        # íŒŒì¼ ì €ì¥
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"test_utf8_korean_report_{timestamp}.pdf"
        
        with open(filename, 'wb') as f:
            f.write(pdf_buffer.getvalue())
        
        file_size = os.path.getsize(filename)
        
        print(f"âœ… UTF-8 í•œê¸€ PDF ìƒì„± ì™„ë£Œ!")
        print(f"ğŸ“„ íŒŒì¼ëª…: {filename}")
        print(f"ğŸ“Š íŒŒì¼ í¬ê¸°: {file_size:,} bytes")
        print(f"ğŸ—£ï¸ ëŒ€í™” ìˆ˜: {len(conversation_history)}ê°œ")
        print(f"ğŸ‘¤ ì‚¬ìš©ì: {session_info['user_id']}")
        print(f"ğŸ”§ ë¬¸ì œ: {session_info['issue_code']}")
        print(f"ğŸ”¤ íŠ¹ìˆ˜ë¬¸ì í…ŒìŠ¤íŠ¸: âœ… ğŸ”§ ğŸ˜Š ğŸ‡°ğŸ‡· ğŸ’¡ ğŸ“‹")
        
        return True
        
    except Exception as e:
        print(f"âŒ PDF ìƒì„± ì‹¤íŒ¨: {e}")
        return False

if __name__ == "__main__":
    asyncio.run(test_utf8_korean_pdf())